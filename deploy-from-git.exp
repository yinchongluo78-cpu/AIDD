#!/usr/bin/expect -f

set timeout 300

set host "47.236.103.35"
set user "root"
set password "Lyc001286"

puts "ğŸš€ å¼€å§‹éƒ¨ç½²å‰ç«¯..."

spawn ssh ${user}@${host}
expect {
    timeout {
        puts "âŒ SSH è¿æ¥è¶…æ—¶"
        exit 1
    }
    "password:" {
        send "${password}\r"
    }
    "yes/no" {
        send "yes\r"
        exp_continue
    }
}

# ç­‰å¾…ç™»å½•æˆåŠŸ
expect "#"

puts "\nğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
send "cd /root/web && git pull origin main\r"
expect {
    "Already up to date" {
        puts "ä»£ç å·²æ˜¯æœ€æ–°"
    }
    "Updating" {
        puts "âœ… ä»£ç æ›´æ–°æˆåŠŸ"
    }
    "password" {
        puts "âŒ Git éœ€è¦å¯†ç ï¼Œè¯·æ£€æŸ¥ä»“åº“é…ç½®"
        exit 1
    }
    timeout {
        puts "âŒ Git pull è¶…æ—¶"
        exit 1
    }
}

expect "#"

puts "\nğŸ”¨ æ„å»ºå‰ç«¯..."
send "cd /root/web && npm run build\r"
expect {
    "built in" {
        puts "âœ… æ„å»ºå®Œæˆ"
    }
    "error" {
        puts "âŒ æ„å»ºå‡ºé”™"
    }
    timeout {
        puts "âŒ æ„å»ºè¶…æ—¶"
        exit 1
    }
}

expect "#"

puts "\nâœ… éƒ¨ç½²å®Œæˆï¼"
send "exit\r"
expect eof
