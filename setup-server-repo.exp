#!/usr/bin/expect -f

set timeout 600

set host "47.236.103.35"
set user "root"
set password "Lyc001286"

puts "ğŸš€ å¼€å§‹åœ¨æœåŠ¡å™¨ä¸Šè®¾ç½®ä»£ç ä»“åº“..."

spawn ssh ${user}@${host}
expect {
    timeout {
        puts "âŒ SSH è¿æ¥è¶…æ—¶"
        exit 1
    }
    "password:" {
        send "${password}\r"
    }
    "yes/no" {
        send "yes\r"
        exp_continue
    }
}

# ç­‰å¾…ç™»å½•æˆåŠŸ
expect {
    "#" { }
    "$" { }
    timeout {
        puts "âŒ ç™»å½•å¤±è´¥"
        exit 1
    }
}

puts "\nğŸ“ æ£€æŸ¥ç°æœ‰ç›®å½•..."
send "ls -la /root/web\r"
expect {
    "#" { }
    "$" { }
}

puts "\nğŸ—‘ï¸  æ¸…ç†æ—§ç›®å½•..."
send "cd /root && rm -rf web\r"
expect {
    "#" { }
    "$" { }
}

puts "\nğŸ“¥ å…‹éš†ä»£ç ä»“åº“..."
send "cd /root && git clone https://github.com/yinchongluo78-cpu/AIDD.git web\r"
expect {
    "Cloning into" {
        puts "âœ… å¼€å§‹å…‹éš†..."
    }
    "already exists" {
        puts "âš ï¸  ç›®å½•å·²å­˜åœ¨"
    }
    timeout {
        puts "âŒ å…‹éš†è¶…æ—¶"
        exit 1
    }
}

expect {
    "done" {
        puts "âœ… ä»£ç å…‹éš†å®Œæˆ"
    }
    "#" { }
    "$" { }
    timeout {
        puts "âŒ ç­‰å¾…å…‹éš†å®Œæˆè¶…æ—¶"
        exit 1
    }
}

puts "\nğŸ“¦ å®‰è£…ä¾èµ–..."
send "cd /root/web && npm install\r"
expect {
    "added" {
        puts "âœ… ä¾èµ–å®‰è£…ä¸­..."
    }
    "up to date" {
        puts "âœ… ä¾èµ–å·²æ˜¯æœ€æ–°"
    }
    timeout {
        puts "âŒ å®‰è£…ä¾èµ–è¶…æ—¶"
        exit 1
    }
}

# ç­‰å¾… npm install å®Œæˆ
expect {
    "#" { }
    "$" { }
    timeout {
        puts "âŒ npm install æ‰§è¡Œè¶…æ—¶"
        exit 1
    }
}

puts "\nğŸ”¨ æ„å»ºå‰ç«¯..."
send "cd /root/web && npm run build\r"
expect {
    "built in" {
        puts "âœ… æ„å»ºæˆåŠŸ"
    }
    "error" {
        puts "âŒ æ„å»ºå‡ºé”™"
    }
    timeout {
        puts "âŒ æ„å»ºè¶…æ—¶"
    }
}

# ç­‰å¾…æ„å»ºå®Œæˆ
expect {
    "#" { }
    "$" { }
    timeout { }
}

puts "\nâœ… éƒ¨ç½²å®Œæˆï¼å‰ç«¯å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬"
puts "åŒ…å«æ–°åŠŸèƒ½ï¼šå¾…è§£ææ–‡æ¡£è­¦å‘Šæç¤º"

send "exit\r"
expect eof
