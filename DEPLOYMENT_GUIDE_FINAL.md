# ğŸš€ LYC AI é¡¹ç›® - å®Œæ•´éƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [ä¿®å¤æ€»ç»“](#ä¿®å¤æ€»ç»“)
2. [éƒ¨ç½²å‰å‡†å¤‡](#éƒ¨ç½²å‰å‡†å¤‡)
3. [éƒ¨ç½²æ­¥éª¤](#éƒ¨ç½²æ­¥éª¤)
4. [éªŒè¯éƒ¨ç½²](#éªŒè¯éƒ¨ç½²)
5. [åç»­é…ç½®](#åç»­é…ç½®)
6. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## ä¿®å¤æ€»ç»“

### âœ… å·²ä¿®å¤çš„æ ¸å¿ƒé—®é¢˜

| é—®é¢˜ | ä¿®å¤æ–¹æ¡ˆ | å½±å“åŠŸèƒ½ |
|------|---------|---------|
| æœ¬åœ°æ–‡ä»¶å­˜å‚¨å¯¼è‡´OCRå¤±è´¥ | é…ç½®é˜¿é‡Œäº‘OSSä¸Šä¼  | å›¾ç‰‡OCRåŠŸèƒ½ |
| å›¾ç‰‡base64æ— æ³•è¢«OCRè¯†åˆ« | å…ˆä¸Šä¼ è·å–URLå†å‘é€ | å›¾ç‰‡è¯†åˆ« |
| ç”¨æˆ·æ— æ³•é€‰æ‹©çŸ¥è¯†åº“ | æ·»åŠ çŸ¥è¯†åº“é€‰æ‹©UI | çŸ¥è¯†åº“æ£€ç´¢ |
| Nginxé…ç½®ä¸å®Œæ•´ | æ·»åŠ ä¸Šä¼ é™åˆ¶å’Œè¶…æ—¶ | å¤§æ–‡ä»¶ä¸Šä¼  |
| æ•æ„Ÿä¿¡æ¯å¯èƒ½æ³„éœ² | å®Œå–„.gitignore | å®‰å…¨æ€§ |

### ğŸ“¦ æ–°å¢æ–‡ä»¶

#### æ ¸å¿ƒä»£ç 
- `api/src/services/oss.ts` - OSSä¸Šä¼ æœåŠ¡
- `web/src/pages/Chat.vue` - æ›´æ–°(æ·»åŠ çŸ¥è¯†åº“é€‰æ‹©å™¨)
- `api/src/routes/upload.ts` - æ›´æ–°(ä½¿ç”¨OSS)

#### é…ç½®æ–‡ä»¶
- `nginx-production.conf` - ç”Ÿäº§ç¯å¢ƒNginxé…ç½®
- `.gitignore` - æ›´æ–°(ä¿æŠ¤æ•æ„Ÿä¿¡æ¯)

#### å·¥å…·è„šæœ¬
- `check-server-status.sh` - æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥
- `deploy-production.sh` - è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

#### æ–‡æ¡£
- `FIXES_APPLIED.md` - è¯¦ç»†ä¿®å¤è®°å½•
- `DEPLOYMENT_GUIDE_FINAL.md` - æœ¬æ–‡æ¡£

---

## éƒ¨ç½²å‰å‡†å¤‡

### 1. æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€

è¿è¡ŒçŠ¶æ€æ£€æŸ¥è„šæœ¬:
```bash
./check-server-status.sh
```

å¯†ç : `Lyc001286`

æ£€æŸ¥é¡¹ç›®:
- âœ“ é¡¹ç›®ç›®å½•æ˜¯å¦å­˜åœ¨
- âœ“ PM2è¿›ç¨‹æ˜¯å¦è¿è¡Œ
- âœ“ Nginxé…ç½®æ˜¯å¦æ­£ç¡®
- âœ“ æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
- âœ“ ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³

### 2. ç¡®è®¤ç¯å¢ƒé…ç½®

**æœåŠ¡å™¨ä¿¡æ¯**:
- åœ°å€: 120.24.22.244
- ç³»ç»Ÿ: Ubuntu/CentOS
- Node.js: v18+
- PM2: å·²å®‰è£…
- Nginx: å·²å®‰è£…

**æ•°æ®åº“**:
- ç±»å‹: PostgreSQL 15
- ä¸»æœº: pgm-wz9ar7chi0iaq54g.pg.rds.aliyuncs.com
- ç«¯å£: 5432
- æ•°æ®åº“: lyc_ai_db

**é˜¿é‡Œäº‘OSS**:
- Region: oss-cn-shenzhen
- Bucket: lyc-ai-storage
- AccessKeyå·²é…ç½®

### 3. å¤‡ä»½ç°æœ‰æ•°æ®(é‡è¦!)

```bash
# ç™»å½•æœåŠ¡å™¨
ssh root@120.24.22.244

# å¤‡ä»½æ•°æ®åº“
pg_dump -h pgm-wz9ar7chi0iaq54g.pg.rds.aliyuncs.com \
  -U postgres -d lyc_ai_db > backup_$(date +%Y%m%d).sql

# å¤‡ä»½å½“å‰ä»£ç 
cd /var/www/lyc-ai
tar -czf ../lyc-ai-backup-$(date +%Y%m%d).tar.gz .
```

---

## éƒ¨ç½²æ­¥éª¤

### æ–¹æ³•ä¸€: è‡ªåŠ¨éƒ¨ç½²(æ¨è)

```bash
# åœ¨æœ¬åœ°é¡¹ç›®ç›®å½•æ‰§è¡Œ
./deploy-production.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨:
1. âœ“ æ£€æŸ¥å¿…è¦æ–‡ä»¶
2. âœ“ å®‰è£…ä¾èµ–
3. âœ“ æ„å»ºå‰ç«¯å’Œåç«¯
4. âœ“ åˆ›å»ºéƒ¨ç½²åŒ…
5. âœ“ ä¸Šä¼ åˆ°æœåŠ¡å™¨
6. âœ“ è§£å‹å¹¶å®‰è£…
7. âœ“ æ›´æ–°Nginxé…ç½®
8. âœ“ é‡å¯æœåŠ¡
9. âœ“ æµ‹è¯•å¥åº·æ£€æŸ¥

### æ–¹æ³•äºŒ: æ‰‹åŠ¨éƒ¨ç½²

å¦‚æœè‡ªåŠ¨éƒ¨ç½²å¤±è´¥,å¯ä»¥æ‰‹åŠ¨æ‰§è¡Œ:

#### æ­¥éª¤1: æœ¬åœ°æ„å»º
```bash
# æ„å»ºå‰ç«¯
cd web
npm install
npm run build
cd ..

# ç¼–è¯‘åç«¯
cd api
npm install
npm run build
cd ..
```

#### æ­¥éª¤2: åˆ›å»ºéƒ¨ç½²åŒ…
```bash
tar -czf deploy-manual.tar.gz \
  web/dist \
  api/dist \
  api/src \
  api/package*.json \
  api/prisma \
  api/.env.production \
  nginx-production.conf
```

#### æ­¥éª¤3: ä¸Šä¼ åˆ°æœåŠ¡å™¨
```bash
scp deploy-manual.tar.gz root@120.24.22.244:/tmp/
```

#### æ­¥éª¤4: æœåŠ¡å™¨éƒ¨ç½²
```bash
ssh root@120.24.22.244

# è§£å‹
cd /var/www/lyc-ai
tar -xzf /tmp/deploy-manual.tar.gz

# å®‰è£…ä¾èµ–
cd api
npm install --production

# æ›´æ–°Nginx
sudo cp /var/www/lyc-ai/nginx-production.conf /etc/nginx/conf.d/lyc-ai.conf
sudo nginx -t
sudo systemctl reload nginx

# é‡å¯æœåŠ¡
pm2 restart lyc-ai-api

# æŸ¥çœ‹çŠ¶æ€
pm2 list
pm2 logs lyc-ai-api --lines 20
```

---

## éªŒè¯éƒ¨ç½²

### 1. å¥åº·æ£€æŸ¥

```bash
# APIå¥åº·æ£€æŸ¥
curl http://120.24.22.244/api/health

# é¢„æœŸè¾“å‡º: {"ok":true}
```

### 2. åŠŸèƒ½æµ‹è¯•

#### æµ‹è¯•å›¾ç‰‡OCRåŠŸèƒ½
1. è®¿é—®: http://120.24.22.244/chat
2. ç‚¹å‡»å›¾ç‰‡ä¸Šä¼ æŒ‰é’®
3. é€‰æ‹©ä¸€å¼ åŒ…å«æ–‡å­—çš„å›¾ç‰‡
4. æ£€æŸ¥æ˜¯å¦èƒ½è¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—

#### æµ‹è¯•çŸ¥è¯†åº“åŠŸèƒ½
1. è®¿é—®: http://120.24.22.244/kb
2. åˆ›å»ºæ–°åˆ†ç±»
3. ä¸Šä¼ ä¸€ä¸ªæ–‡æ¡£
4. è¿”å›å¯¹è¯é¡µé¢
5. é€‰æ‹©åˆšåˆ›å»ºçš„çŸ¥è¯†åº“
6. æé—®ç›¸å…³é—®é¢˜
7. æ£€æŸ¥AIæ˜¯å¦å¼•ç”¨æ–‡æ¡£å†…å®¹

#### æµ‹è¯•å¤§æ–‡ä»¶ä¸Šä¼ 
1. å°è¯•ä¸Šä¼ 50MBä»¥ä¸Šçš„æ–‡æ¡£
2. æ£€æŸ¥æ˜¯å¦ä¸Šä¼ æˆåŠŸ

### 3. æŸ¥çœ‹æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
ssh root@120.24.22.244 'pm2 logs lyc-ai-api --lines 50'

# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
ssh root@120.24.22.244 'tail -f /var/log/nginx/error.log'
```

---

## åç»­é…ç½®

### 1. é…ç½®åŸŸåå’ŒHTTPS

ä½ æåˆ°å·²è´­ä¹°åŸŸå,ç°åœ¨å¯ä»¥é…ç½®:

#### æ­¥éª¤1: åŸŸåè§£æ
åœ¨é˜¿é‡Œäº‘åŸŸåæ§åˆ¶å°æ·»åŠ Aè®°å½•:
```
ç±»å‹: A
ä¸»æœºè®°å½•: @ (æˆ– www)
è®°å½•å€¼: 120.24.22.244
TTL: 600
```

#### æ­¥éª¤2: ç”³è¯·SSLè¯ä¹¦
```bash
ssh root@120.24.22.244

# å®‰è£…certbot
sudo apt install certbot python3-certbot-nginx

# ç”³è¯·è¯ä¹¦(æ›¿æ¢your-domain.com)
sudo certbot --nginx -d your-domain.com -d www.your-domain.com
```

#### æ­¥éª¤3: æ›´æ–°å‰ç«¯é…ç½®
ä¿®æ”¹ `web/.env.production`:
```
VITE_API_URL=https://your-domain.com/api
```

é‡æ–°éƒ¨ç½²å‰ç«¯ã€‚

### 2. æ¸…ç†ä¸´æ—¶æ–‡ä»¶

```bash
# æœ¬åœ°æ¸…ç†(åœ¨é¡¹ç›®ç›®å½•)
rm -f deploy-*.sh fix-*.sh check-*.sh
rm -f *.tar.gz
rm -f deploy-*.tar.gz

# æœåŠ¡å™¨æ¸…ç†
ssh root@120.24.22.244 'rm -f /tmp/deploy-*.tar.gz'
```

### 3. æäº¤ä»£ç 

**é‡è¦**: ç¡®ä¿æ•æ„Ÿä¿¡æ¯å·²æ’é™¤
```bash
# æŸ¥çœ‹å°†è¦æäº¤çš„æ–‡ä»¶
git status

# ç¡®è®¤.env.productionä¸åœ¨åˆ—è¡¨ä¸­
# å¦‚æœåœ¨,è¿è¡Œ: git rm --cached api/.env.production

# æäº¤ä¿®å¤
git add .
git commit -m "ä¿®å¤: é…ç½®OSSä¸Šä¼ ã€æ·»åŠ çŸ¥è¯†åº“é€‰æ‹©UIã€æ›´æ–°Nginxé…ç½®"
git push
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜1: å›¾ç‰‡ä¸Šä¼ å¤±è´¥

**ç—‡çŠ¶**: ä¸Šä¼ å›¾ç‰‡æ—¶æŠ¥é”™

**æ’æŸ¥**:
```bash
# æ£€æŸ¥OSSé…ç½®
ssh root@120.24.22.244 'cat /var/www/lyc-ai/api/.env.production | grep OSS'

# æ£€æŸ¥PM2æ—¥å¿—
ssh root@120.24.22.244 'pm2 logs lyc-ai-api | grep -i oss'
```

**è§£å†³**:
- ç¡®è®¤OSS AccessKeyé…ç½®æ­£ç¡®
- ç¡®è®¤OSS Bucketå­˜åœ¨ä¸”æœ‰æƒé™
- æ£€æŸ¥ali-ossåŒ…æ˜¯å¦å®‰è£…: `npm list ali-oss`

### é—®é¢˜2: çŸ¥è¯†åº“æ£€ç´¢æ— ç»“æœ

**ç—‡çŠ¶**: é€‰æ‹©çŸ¥è¯†åº“åAIæ— æ³•å¼•ç”¨æ–‡æ¡£

**æ’æŸ¥**:
```bash
# æ£€æŸ¥æ–‡æ¡£æ˜¯å¦è§£æ
ssh root@120.24.22.244 'pm2 logs lyc-ai-api | grep "è§£æ"'

# æ£€æŸ¥æ•°æ®åº“ä¸­çš„chunks
# (éœ€è¦è¿æ¥æ•°æ®åº“æŸ¥è¯¢kb_chunksè¡¨)
```

**è§£å†³**:
- é‡æ–°ä¸Šä¼ æ–‡æ¡£
- æ£€æŸ¥documentParseræœåŠ¡æ˜¯å¦æ­£å¸¸
- æŸ¥çœ‹æ–‡æ¡£çŠ¶æ€æ˜¯å¦ä¸º"ready"

### é—®é¢˜3: Nginx 502é”™è¯¯

**ç—‡çŠ¶**: è®¿é—®ç½‘ç«™æ˜¾ç¤º502 Bad Gateway

**æ’æŸ¥**:
```bash
# æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ
ssh root@120.24.22.244 'pm2 list'

# æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
ssh root@120.24.22.244 'netstat -tlnp | grep 3001'
```

**è§£å†³**:
```bash
# é‡å¯åç«¯
ssh root@120.24.22.244 'pm2 restart lyc-ai-api'

# å¦‚æœè¿˜æœ‰é—®é¢˜,æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
ssh root@120.24.22.244 'pm2 logs lyc-ai-api --err'
```

### é—®é¢˜4: å¤§æ–‡ä»¶ä¸Šä¼ å¤±è´¥

**ç—‡çŠ¶**: ä¸Šä¼ å¤§æ–‡ä»¶æ—¶è¶…æ—¶æˆ–413é”™è¯¯

**æ’æŸ¥**:
```bash
# æ£€æŸ¥Nginxé…ç½®
ssh root@120.24.22.244 'grep client_max_body_size /etc/nginx/conf.d/lyc-ai.conf'
```

**è§£å†³**:
- ç¡®è®¤ä½¿ç”¨äº†æ–°çš„nginx-production.conf
- è¿è¡Œ: `sudo nginx -t && sudo systemctl reload nginx`

---

## ğŸ‰ å®Œæˆ!

éƒ¨ç½²å®Œæˆå,ä½ çš„åº”ç”¨åº”è¯¥:
- âœ… å›¾ç‰‡OCRåŠŸèƒ½æ­£å¸¸
- âœ… çŸ¥è¯†åº“æ£€ç´¢åŠŸèƒ½æ­£å¸¸
- âœ… å¯ä»¥ä¸Šä¼ å¤§æ–‡ä»¶(æœ€å¤§100MB)
- âœ… AIæµå¼å“åº”ä¸è¶…æ—¶
- âœ… æ•æ„Ÿä¿¡æ¯å·²ä¿æŠ¤

**è®¿é—®åœ°å€**: http://120.24.22.244 (æˆ–ä½ çš„åŸŸå)

**ä¸‹ä¸€æ­¥**:
1. é…ç½®åŸŸåå’ŒHTTPS(æå‡å®‰å…¨æ€§å’Œç”¨æˆ·ä¿¡ä»»)
2. æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
3. æ”¶é›†ç”¨æˆ·åé¦ˆ
4. ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€

---

## ğŸ“ è”ç³»æ”¯æŒ

é‡åˆ°é—®é¢˜?
1. å…ˆè¿è¡Œ `./check-server-status.sh` æ£€æŸ¥çŠ¶æ€
2. æŸ¥çœ‹ `FIXES_APPLIED.md` äº†è§£ä¿®å¤è¯¦æƒ…
3. æŸ¥çœ‹PM2æ—¥å¿—å®šä½é—®é¢˜

**é‡è¦æé†’**:
- å®šæœŸå¤‡ä»½æ•°æ®åº“
- å®šæœŸæ›´æ–°ä¾èµ–åŒ…
- ç›‘æ§æœåŠ¡å™¨èµ„æºä½¿ç”¨æƒ…å†µ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.1.0
**æœ€åæ›´æ–°**: 2025-09-30
**ç»´æŠ¤è€…**: Claude AI Assistant