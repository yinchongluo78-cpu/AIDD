#!/usr/bin/expect -f

set timeout 900
log_user 1

set host "47.236.103.35"
set user "root"
set password "Lyc001286"

puts "\n========================================="
puts "å°è¯•è¿æ¥æœåŠ¡å™¨: ${host}"
puts "=========================================\n"

spawn ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 ${user}@${host}

set connection_established 0

expect {
    timeout {
        puts "\nâŒ è¿æ¥è¶…æ—¶ï¼Œæ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨"
        puts "å¯èƒ½åŸå› ï¼š"
        puts "1. ç½‘ç»œè¿æ¥é—®é¢˜"
        puts "2. æœåŠ¡å™¨é˜²ç«å¢™é˜»æ­¢è¿æ¥"
        puts "3. SSH æœåŠ¡æœªè¿è¡Œ"
        exit 1
    }
    "password:" {
        set connection_established 1
        send "${password}\r"
        exp_continue
    }
    "yes/no" {
        send "yes\r"
        exp_continue
    }
    -re "#|\\$" {
        if {$connection_established == 0} {
            puts "âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨ï¼ˆæ— éœ€å¯†ç ï¼‰"
            set connection_established 1
        }
    }
    "Permission denied" {
        puts "\nâŒ å¯†ç é”™è¯¯æˆ–æƒé™è¢«æ‹’ç»"
        exit 1
    }
}

if {$connection_established == 1} {
    puts "\nâœ… SSH è¿æ¥æˆåŠŸï¼\n"

    puts "========================================="
    puts "å¼€å§‹éƒ¨ç½²æµç¨‹"
    puts "=========================================\n"

    # 1. æ¸…ç†æ—§ç›®å½•
    puts "ğŸ—‘ï¸  æ­¥éª¤1: æ¸…ç†æ—§ç›®å½•..."
    send "cd /root && rm -rf web\r"
    expect -re "#|\\$"
    puts "âœ… å®Œæˆ\n"

    # 2. å…‹éš†ä»“åº“
    puts "ğŸ“¥ æ­¥éª¤2: å…‹éš†ä»£ç ä»“åº“..."
    send "git clone https://github.com/yinchongluo78-cpu/AIDD.git web\r"
    expect {
        "Cloning" {
            puts "æ­£åœ¨å…‹éš†..."
            exp_continue
        }
        "done" {
            puts "âœ… å…‹éš†å®Œæˆ\n"
        }
        timeout {
            puts "âš ï¸  å…‹éš†å¯èƒ½è¶…æ—¶ï¼Œç»§ç»­æ‰§è¡Œ...\n"
        }
    }
    expect -re "#|\\$"

    # 3. å®‰è£…ä¾èµ–
    puts "ğŸ“¦ æ­¥éª¤3: å®‰è£…ä¾èµ–..."
    send "cd /root/web && npm install\r"
    expect {
        -re "added|up to date" {
            puts "ä¾èµ–å®‰è£…ä¸­..."
            exp_continue
        }
        -re "#|\\$" {
            puts "âœ… ä¾èµ–å®‰è£…å®Œæˆ\n"
        }
        timeout {
            puts "âš ï¸  npm install è¶…æ—¶ï¼Œç»§ç»­æ‰§è¡Œ...\n"
        }
    }

    # 4. æ„å»ºå‰ç«¯
    puts "ğŸ”¨ æ­¥éª¤4: æ„å»ºå‰ç«¯..."
    send "cd /root/web && npm run build\r"
    expect {
        "built in" {
            puts "âœ… æ„å»ºæˆåŠŸ\n"
        }
        "error" {
            puts "âŒ æ„å»ºå‡ºé”™\n"
        }
        timeout {
            puts "âš ï¸  æ„å»ºè¶…æ—¶\n"
        }
    }
    expect -re "#|\\$"

    # 5. éªŒè¯
    puts "âœ… æ­¥éª¤5: éªŒè¯æ„å»ºç»“æœ..."
    send "ls -la /root/web/dist/ | head -10\r"
    expect -re "#|\\$"

    puts "\n========================================="
    puts "âœ… éƒ¨ç½²å®Œæˆï¼"
    puts "=========================================\n"

    send "exit\r"
}

expect eof
