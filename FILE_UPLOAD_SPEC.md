# 文件上传功能说明文档

## 📋 总览

| 上传类型 | 一次上传数量 | 单个文件大小限制 | 支持格式 | OCR识别 |
|---------|------------|----------------|---------|--------|
| **对话图片** | 单张 | 5MB | 所有图片格式 | ✅ 支持 |
| **对话文档** | 单个 | 100MB | PDF/DOCX/TXT/MD/CSV/JSON/XML | ❌ 不支持 |
| **知识库文档** | 批量多个 | 100MB/个 | PDF/DOCX/TXT/MD | ❌ 不支持 |
| **用户头像** | 单张 | 100MB | 所有图片格式 | ❌ 不支持 |

---

## 1️⃣ 对话页面 - 图片上传

### 功能位置
- 页面：对话页（/chat）
- 位置：输入框左侧第一个按钮（图片图标）

### 限制详情
- **数量限制**：每次只能上传 **1张图片**
- **大小限制**：**5MB**
- **格式限制**：`image/*`（支持所有常见图片格式：JPG, PNG, GIF, WEBP等）
- **OCR识别**：✅ **支持自动识别**
  - 使用：阿里云通义千问 (qwen-vl-plus)
  - 功能：自动识别图片中的文字和题目内容
  - 识别内容会自动拼接到对话上下文中发送给AI

### 代码位置
- 前端：`web/src/pages/Chat.vue:641-665`
- 后端：`api/src/routes/upload.ts:17-46`
- OCR服务：`api/src/services/tongyi.ts:46-57`

### 上传流程
1. 用户选择图片
2. 前端校验大小（5MB）
3. 上传到阿里云OSS（`images/` 目录）
4. 调用阿里云OCR识别图片内容
5. 识别结果 + 用户输入一起发送给DeepSeek AI

### 超限提示
```
图片大小不能超过5MB
```

---

## 2️⃣ 对话页面 - 文档上传

### 功能位置
- 页面：对话页（/chat）
- 位置：输入框左侧第二个按钮（文档图标 + 下拉箭头）
- 说明：点击后有两个选项："上传到对话" 和 "上传到知识库"

### 限制详情（上传到对话）
- **数量限制**：每次只能上传 **1个文档**
- **大小限制**：**100MB**
- **格式限制**：`.txt, .pdf, .md, .markdown, .doc, .docx, .csv, .json, .xml`
- **OCR识别**：❌ **不支持**（仅上传，不自动解析内容）

### 代码位置
- 前端：`web/src/pages/Chat.vue:945-975`
- 后端：`api/src/routes/upload.ts:49-90`

### 上传流程
1. 用户选择文档
2. 前端校验大小（100MB）
3. 上传到阿里云OSS（`documents/` 目录）
4. 显示文档名称和大小在消息中
5. **不会自动解析内容**，只是作为上传记录

### 超限提示
```
文件大小不能超过100MB
```

---

## 3️⃣ 知识库页面 - 批量文档上传

### 功能位置
- 页面：知识库页（/kb）
- 位置：选中分类后，右上角"上传文档"按钮

### 限制详情
- **数量限制**：支持 **批量上传多个文档**（无具体数量限制）
- **大小限制**：每个文档 **100MB**
- **格式限制**：`.pdf, .doc, .docx, .txt, .md, .markdown`
- **OCR识别**：❌ **不支持OCR**
- **文档解析**：✅ **支持文本解析**
  - PDF：使用 `pdf-parse` 提取文本
  - DOCX：使用 `mammoth` 提取文本
  - TXT/MD：直接读取文本
  - 自动切片（每片约400字）存入数据库用于检索

### 代码位置
- 前端：`web/src/pages/Kb.vue:48-52, 354-420`
- 后端上传：`api/src/routes/upload.ts:49-90`
- 文档解析：`api/src/services/documentParser.ts:16-144`

### 上传流程（每个文件）
1. 用户选择多个文档（支持批量）
2. 前端逐个校验大小（100MB）
3. 逐个上传到阿里云OSS（`documents/` 目录）
4. 创建文档记录到数据库
5. **后台异步解析**文档内容并分片存储
6. 支持实时上传进度显示（0-70%上传，70-100%处理）

### 超限提示
```
文件"xxx.pdf"超过100MB限制
```

### 批量上传特性
- ✅ 支持一次性选择多个文件
- ✅ 按顺序逐个上传（串行处理）
- ✅ 单个文件失败不影响其他文件
- ✅ 实时显示当前上传文件名和进度

---

## 4️⃣ 用户头像上传

### 功能位置
- 页面：个人资料弹窗
- 位置：左下角头像 → 个人资料 → 头像选择区

### 限制详情
- **数量限制**：单张
- **大小限制**：**100MB**（实际头像应该很小）
- **格式限制**：所有图片格式
- **OCR识别**：❌ 不需要

### 代码位置
- 后端：`api/src/routes/upload.ts:93-115`

---

## 🔍 OCR 图片识别详细说明

### 仅支持对话页面的图片上传
- ✅ **对话页 - 图片按钮**：支持OCR
- ❌ **对话页 - 文档上传**：不支持OCR
- ❌ **知识库 - 文档上传**：不支持OCR
- ❌ **头像上传**：不支持OCR

### OCR 识别能力
使用阿里云通义千问多模态模型 (qwen-vl-plus)，可以识别：
1. ✅ 图片中的文字内容
2. ✅ 数学公式和题目
3. ✅ 表格数据
4. ✅ 手写字（识别率一般）
5. ✅ 题目类型判断
6. ✅ 提供解题思路和学习建议

### 识别提示词
```
请仔细分析这张作业图片：
1. 识别题目内容
2. 分析题目类型（数学、语文、英语等）
3. 如果是习题，提供解题思路
4. 如果有错误，指出并解释
5. 给出学习建议

请用友好的语言，适合学生理解的方式回答。
```

### 技术实现
- API: `https://dashscope.aliyuncs.com/api/v1/services/aigc/multimodal-generation/generation`
- 模型: `qwen-vl-plus`
- 最大token: 1000
- 认证: Bearer Token (TONGYI_API_KEY)

---

## 🗂️ 文档解析详细说明

### 支持解析的格式
| 格式 | 解析库 | 提取内容 |
|------|--------|---------|
| PDF | pdf-parse | 纯文本（不含图片） |
| DOCX | mammoth | 纯文本（不含图片） |
| TXT | fs | 全部内容 |
| MD/Markdown | fs | 全部内容 |

### 解析流程
1. 从OSS下载文档（使用预签名URL，1小时有效）
2. 根据文件扩展名选择解析器
3. 提取纯文本内容
4. 清理内容（去除页眉页脚、多余换行等）
5. 按约400字切片（智能边界识别：句号、问号、换行等）
6. 每片内容前后重叠50字（保证上下文连贯）
7. 存储到 `kb_chunks` 表用于检索

### 解析限制
- ❌ 不支持图片中的文字（需要先OCR）
- ❌ 不支持复杂格式（表格、公式可能丢失格式）
- ✅ 支持中文分词和关键词检索
- ✅ 支持跨文档检索（基于关键词匹配）

---

## 📊 文件大小限制汇总

### 阿里云OSS限制
- Bucket类型：私有
- 文件上传限制：**100MB**（由 multer 中间件控制）

### 各场景限制
```javascript
// 对话图片：5MB
if (file.size > 5 * 1024 * 1024) {
  alert('图片大小不能超过5MB')
}

// 对话文档 & 知识库文档 & 头像：100MB
if (file.size > 100 * 1024 * 1024) {
  alert('文件大小不能超过100MB')
}
```

### 后端multer配置
```javascript
// api/src/routes/upload.ts:9-14
const upload = multer({
  storage: multer.memoryStorage(),
  limits: {
    fileSize: 100 * 1024 * 1024 // 100MB
  }
})
```

---

## 🚨 建议与注意事项

### 1. 图片大小建议
- 对话图片建议压缩到 **1-2MB** 以内，识别效果更好，上传更快
- 如果只是文字识别，**500KB** 以下足够清晰

### 2. 文档格式建议
- **推荐格式**：PDF、DOCX（解析效果最好）
- **轻量格式**：TXT、MD（纯文本，最稳定）
- **避免格式**：扫描版PDF（无法提取文字，需先OCR）

### 3. 批量上传建议
- 知识库批量上传时，建议单次不超过 **10个文件**
- 大文件（>50MB）建议单独上传，避免超时

### 4. OCR使用建议
- 图片尽量清晰、光线充足
- 文字尽量水平拍摄（避免倾斜）
- 避免反光、遮挡
- 手写字建议工整，识别率更高

---

## 🔧 相关配置文件

### 环境变量
```bash
# .env
TONGYI_API_KEY=sk-xxx  # 阿里云通义千问API密钥（用于OCR）
OSS_ACCESS_KEY_ID=xxx  # 阿里云OSS访问密钥
OSS_ACCESS_KEY_SECRET=xxx
OSS_BUCKET=lyc-ai-storage  # OSS Bucket名称
OSS_REGION=oss-cn-shenzhen  # OSS区域
```

### 关键代码位置
- 上传配置：`api/src/routes/upload.ts`
- OCR服务：`api/src/services/tongyi.ts`
- 文档解析：`api/src/services/documentParser.ts`
- 对话页上传：`web/src/pages/Chat.vue`
- 知识库上传：`web/src/pages/Kb.vue`
